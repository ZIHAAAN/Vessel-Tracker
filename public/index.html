<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Mapbox GL JS Example</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #data { position: absolute; bottom: 10px; left: 10px; background: rgba(255, 255, 255, 0.8); padding: 10px; max-height: 200px; overflow-y: scroll; width: 300px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="data"></div>
    
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        // 设置 Mapbox 的访问令牌
        mapboxgl.accessToken = 'pk.eyJ1IjoiamFkZW5sZW1tb24iLCJhIjoiY2swaHF6OGhhMDVoczNtcXJ1eWJhNzljMCJ9.rh0Da7Ct2szjyDfqW5MyTg';

        // 初始化地图
        const map = new mapboxgl.Map({
            container: 'map', // 地图容器的ID
            style: 'mapbox://styles/mapbox/streets-v11', // 地图样式
            center: [175.318526, -37.788266], // 初始地图中心 [经度, 纬度]
            zoom: 8 // 初始地图缩放级别
        });

        // 存储所有标记的对象，以 MMSI 作为键
        const markers = {};

        // 连接到 WebSocket 服务器
        const socket = new WebSocket(`ws://${window.location.host}`);

        // 地图加载完成后，发送初始范围
        map.on('load', sendMapBounds);

        // 当地图视图发生变化时，发送新的地图范围
        map.on('moveend', sendMapBounds);
        // 当地图视图发生变化时，延迟 200 毫秒发送新的地图范围
        //map.on('moveend', _.debounce(sendMapBounds, 200));

        socket.onmessage = function(event) {
            const ships = JSON.parse(event.data);
            const mapBounds = map.getBounds(); // 获取当前地图视图范围
            ships.forEach(aisMessage => {
                const mmsi = aisMessage.MMSI;
                const latitude = aisMessage.Latitude;
                const longitude = aisMessage.Longitude;

                // 检查该 MMSI 是否已有标记
                if (markers[mmsi]) {
                    // 更新现有标记的位置
                    markers[mmsi].setLngLat([longitude, latitude]);
                } else {
                    // 创建新的标记并存储在 markers 对象中
                    const marker = new mapboxgl.Marker()
                        .setLngLat([longitude, latitude])
                        .addTo(map);
                    
                    markers[mmsi] = marker;
                }
            });
            // 输出当前地图上的标记总数
            console.log('Total number of markers:', Object.keys(markers).length);

            // 当标记总数超过500时，清除屏幕外的标记点
            if (Object.keys(markers).length > 200) {
                Object.keys(markers).forEach(mmsi => {
                    const marker = markers[mmsi];
                    const markerLngLat = marker.getLngLat();

                    // 检查标记点是否在当前视图范围内
                    if (!mapBounds.contains(markerLngLat)) {
                        // 如果标记点不在范围内，移除它并从 markers 对象中删除
                        marker.remove();
                        delete markers[mmsi];
                    }
                });
                console.log('Markers outside the view have been removed.');
            }
        };

        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        // 将当前地图的边界范围发送到后端
        function sendMapBounds() {
            console.log('map area update')
            if (socket.readyState === WebSocket.OPEN) {
                const bounds = map.getBounds();
                const boundsData = {
                    west: bounds.getWest(),
                    east: bounds.getEast(),
                    south: bounds.getSouth(),
                    north: bounds.getNorth()
                };
                socket.send(JSON.stringify(boundsData));
            }
        }
    </script>
</body>
</html>
